{% extends "base.html" %}
{% load static %}
{% block title %}–ú–æ–∏ —Ü–µ–ª–∏{% endblock %}

{% block content %}
{% if user.is_authenticated %}
<div class="goals-page form-container" style="max-width:1000px;">
  <h2 style="color:#4a148c; margin-top:0;">–ú–æ–∏ —Ü–µ–ª–∏</h2>

  <!-- üîç –§–∏–ª—å—Ç—Ä—ã -->
  <div class="filter-toggle-wrapper">
    <button id="toggleFilters" class="btn" style="width:auto;">–§–∏–ª—å—Ç—Ä—ã</button>
  </div>

  <form id="goalsFilter" class="goals-filter collapsed" onsubmit="return false;">
    <div class="filter-inner">
      <input type="text" id="filter_q" name="q" placeholder="–ü–æ–∏—Å–∫..." style="flex:1; min-width:150px;">

      <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
      <select id="filter_status" name="status" class="status-select">
        <option value="">–í—Å–µ</option>
        <option value="default">–û–±—ã—á–Ω—ã–µ</option>
        <option value="important">–í–∞–∂–Ω—ã–µ</option>
        <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
      </select>

      <!-- –î–∞—Ç—ã —Å –ø–æ–¥–ø–∏—Å—è–º–∏ -->
      <div class="filter-dates">
        <label>
          <span>–æ—Ç</span>
          <input type="date" id="filter_from" name="from">
        </label>
        <label>
          <span>–¥–æ</span>
          <input type="date" id="filter_to" name="to">
        </label>
      </div>

      <div class="filter-buttons">
        <button id="applyFilters" class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button id="resetFilters" type="button" class="btn btn-alt">–°–±—Ä–æ—Å</button>
      </div>
    </div>
  </form>

  <!-- üîò –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
    <button class="open-goal-modal btn">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</button>
    <a href="{% url 'planner:home' %}" class="btn btn-alt">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
  </div>

  <!-- üìã –¢–∞–±–ª–∏—Ü–∞ —Ü–µ–ª–µ–π -->
  <div id="goalsContainer">
    {% if goals %}
    <table class="goals-table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#f7f5fb;">
          <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
          <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–î–∞—Ç–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="goalsTableBody">
        {% for g in goals %}
        <tr class="goal-row {{ g.status }}">
          <td>{{ g.title }}</td>
          <td>{{ g.description|default:"‚Äî" }}</td>
          <td data-time="{{ g.datetime|date:'H:i' }}">{{ g.datetime|date:'d.m.Y' }}</td>
          <td>
            <div class="goal-actions">
              <button type="button" class="goal-action edit" data-id="{{ g.id }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                <i data-lucide="pencil"></i>
              </button>
              <button type="button" class="goal-action danger" data-id="{{ g.id }}" title="–£–¥–∞–ª–∏—Ç—å">
                <i data-lucide="trash-2"></i>
              </button>
              {% if g.status != "completed" %}
              <button type="button" class="goal-action complete" data-id="{{ g.id }}" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">
                <i data-lucide="check"></i>
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>–ü–æ–∫–∞ —Ü–µ–ª–µ–π –Ω–µ—Ç. –ù–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å¬ª.</p>
    {% endif %}
  </div>
</div>

<!-- ================= –ú–û–î–ê–õ–ö–ê: –î–û–ë–ê–í–õ–ï–ù–ò–ï / –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ================= -->
<div id="goalModal" class="modal hidden">
  <div class="modal-content">
    <span class="close" id="closeGoalModal">&times;</span>
    <h2>–ù–æ–≤–∞—è —Ü–µ–ª—å</h2>
    <form id="goalForm" method="post">
      {% csrf_token %}
      <input type="hidden" name="goal_id" id="goalId">

      <div class="form-group">
        <label for="goalTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
        <input type="text" name="title" id="goalTitle" required>
      </div>

      <div class="form-group">
        <label for="goalDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
        <textarea name="description" id="goalDescription"></textarea>
      </div>

      <div class="form-group">
        <label for="goalDate">–î–∞—Ç–∞:</label>
        <input type="date" name="date" id="goalDate" required>
      </div>

      <div class="form-group">
        <label for="goalTime">–í—Ä–µ–º—è:</label>
        <input type="time" name="time" id="goalTime" required>
      </div>

      <div class="form-group">
        <label for="goalStatus">–°—Ç–∞—Ç—É—Å:</label>
        <select name="status" id="goalStatus">
          <option value="default">–û–±—ã—á–Ω–∞—è</option>
          <option value="important">–í–∞–∂–Ω–∞—è</option>
        </select>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" id="deleteGoalBtn" class="btn btn-danger" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= –ú–û–î–ê–õ–ö–ê: –£–î–ê–õ–ï–ù–ò–ï ================= -->
<div id="deleteModal" class="modal hidden">
  <div class="modal-content">
    <h2>–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?</h2>
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å?</p>
    <div class="modal-actions">
      <button id="confirmDelete" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
      <button id="cancelDelete" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

{% else %}
  <div class="welcome">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ü–µ–ª–∏.</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  window.goalUrls = {
    add: "{% url 'planner:add_goal' %}",
    editPattern: "{% url 'planner:edit_goal' 0 %}",
    deletePattern: "{% url 'planner:delete_goal' 0 %}",
    api: "{% url 'planner:goals_api' %}"
  };
</script>

<script src="{% static 'js/goal_modal.js' %}"></script>
<script src="{% static 'js/toast.js' %}"></script>

<!-- üîß JS –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('goalsFilter');
  const tableBody = document.getElementById('goalsTableBody');

  // üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
  const escapeHTML = (text) => {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  };

  async function loadFilteredGoals() {
    const params = new URLSearchParams(new FormData(form));
    const res = await fetch(`/goals/?${params.toString()}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (!res.ok) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∏–ª—å—Ç—Ä–∞");
      return;
    }

    const data = await res.json();
    tableBody.innerHTML = '';

    if (!data.length) {
      tableBody.innerHTML = '<tr><td colspan="4">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
      return;
    }

    data.forEach(g => {
      const title = escapeHTML(g.title || '‚Äî');
      const description = g.description && g.description.trim() !== ''
        ? escapeHTML(g.description)
        : '‚Äî';
      const dateStr = g.datetime ? new Date(g.datetime).toLocaleDateString('ru-RU') : '';

      const row = document.createElement('tr');
      row.className = `goal-row ${g.status}`;
      row.innerHTML = `
        <td>${title}</td>
        <td>${description}</td>
        <td>${dateStr}</td>
        <td>
          <div class="goal-actions">
            <button type="button" class="goal-action edit" data-id="${g.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
              <i data-lucide="pencil"></i>
            </button>
            <button type="button" class="goal-action danger" data-id="${g.id}" title="–£–¥–∞–ª–∏—Ç—å">
              <i data-lucide="trash-2"></i>
            </button>
            ${g.status !== 'completed' ? `
              <button type="button" class="goal-action complete" data-id="${g.id}" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">
                <i data-lucide="check"></i>
              </button>` : ''}
          </div>
        </td>
      `;
      tableBody.appendChild(row);
    });

    if (window.lucide) lucide.createIcons();
  }

  // ===== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ =====
  document.getElementById('applyFilters').addEventListener('click', loadFilteredGoals);
  document.getElementById('resetFilters').addEventListener('click', () => {
    form.reset();
    loadFilteredGoals();
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  if (window.lucide) lucide.createIcons();

  const toggleBtn = document.getElementById("toggleFilters");
  const filterForm = document.getElementById("goalsFilter");

  if (toggleBtn && filterForm) {
    toggleBtn.addEventListener("click", () => {
      filterForm.classList.toggle("collapsed");
    });
  }
});
</script>
{% endblock %}
